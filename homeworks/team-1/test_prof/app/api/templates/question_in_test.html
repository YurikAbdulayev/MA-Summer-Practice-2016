<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Профорієнтаційний тест</title>
    <link rel="stylesheet" href="../static/css/main.min.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:600,400&subset=latin,cyrillic' rel='stylesheet'
          type='text/css'>
    <!--<script src="js/run_test.js"></script>-->
</head>
<body>
<h1 class="head-text" id="number_question_in_list"></h1>
<div id="content">
    <h1 class="head-text">
        <div id="question_body"></div>
    </h1>
    <div id="block_answers_in_q" class="test">
        <!--<p class="answer"><input type="radio" id="radio1" name="answer" value="a1"><label for="radio1">з розповідей, на-->
        <!--слух</label></p>-->
        <!--<p class="answer"><input type="radio" id="radio2" name="answer" value="a2"><label for="radio2">візуально (люблю-->
        <!--ілюстрації)</label></p>-->
        <!--<p class="answer"><input type="radio" id="radio3" name="answer" value="a3"><label for="radio3">через дії,-->
        <!--практично</label></p>-->
        <!--<p class="answer"><input type="radio" id="radio4" name="answer" value="a4"><label for="radio4">з Інтернету,-->
        <!--книг, довідників</label></p>-->
        <!--<a href="" class="button">Назад</a>-->
        <!--<button onclick="loadTests()" type="submit" class="button">Далі</button>-->
    </div>
</div>
<script type="text/javascript">
    var list_answers = localStorage.getItem("list_answ");
//    localStorage.removeItem("list_answ");
    var l = JSON.parse(list_answers);
    var xmlhttp = new XMLHttpRequest();
    if (list_answers == null) {
        var id = '{{t_id}}';
        var ids = [];
        outTest = [];
        var url = "http://127.0.0.1:5000/api/v1.0/questions/" + id + "/direction/0";

        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                parseListIds(xmlhttp.responseText);
            }
        };
        xmlhttp.open("GET", url, false);
        xmlhttp.send();

        function parseListIds(response) {

            var json = JSON.parse(response);
            for (i = 0; i < json["list_ids"].length; i++) {
                ids[i] = json["list_ids"][i]["question_id"]
            }
            list_answers = '{"count": "' + parseInt(json["list_ids"].length) + '", "answers":[], "questions":[' + ids + ']}';
            localStorage.setItem("list_answ", list_answers);
            alert("local storage not exist");
            nextQuestion()
        }
    } else {
        alert("local storage exist");
        alert(JSON.stringify(l));
        nextQuestion()
    }

    function nextQuestion() {
        var obj = l;
        endPart = false;
        for (qw = 0; qw < obj["count"]; qw++) {
            if (obj["answers"][qw] == null) {
                getQuestion(qw, obj);
                endPart = false;
                break
            }
            endPart = true;
        }
        if (endPart){
            localStorage.removeItem("list_answ");
            alert("end first Part");
//            next part test
        }
    }

    function getQuestion(questionId, obj) {
        var url = "http://127.0.0.1:5000/api/v1.0/question/" + obj["questions"][questionId];
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                parseQuestion(xmlhttp.responseText, questionId, obj);
            }
        };
        xmlhttp.open("GET", url, false);
        xmlhttp.send();
    }

    function parseQuestion(result, questionId, storage) {
        var obj = JSON.parse(result);
        st = storage;
        q_id = questionId;
        var outAsnwers = "";
        document.getElementById("question_body").innerHTML = obj["question"]["body"];
        document.getElementById("number_question_in_list").innerHTML = questionId + 1 + " із " + storage["count"];
        ans = obj["question"];
        outAsnwers += "<div id='myForm'>";
        for (i = 0; i < ans["answers"].length; i++) {
            outAsnwers += "<p class='answer'><input type='radio' id='radio" + ans["answers"][i]["direction"] + "' " +
                    "name='answer' value='" + ans["answers"][i]["direction"] + "'>" +
                    "<label for='radio" + ans["answers"][i]["direction"] + "'" +
                    ">" + ans["answers"][i]["body"] + "</label></p>"
        }
        outAsnwers += "</div>";
        outAsnwers += "<button onclick='calcAnswer(q_id)' type='submit' class='button'>Далі</input>";
        document.getElementById("block_answers_in_q").innerHTML = outAsnwers;
    }

    function calcAnswer(questionId) {
        var answer = document.getElementsByName("answer");
        var answCount = answer.length;
        for (a = 0; a < answCount; a++) {
            if (answer[a].checked) {
                l["answers"][questionId] = parseInt(answer[a].value);
                alert(JSON.stringify(l));
                localStorage.setItem("list_answ", JSON.stringify(l));
                nextQuestion()
            }
        }
    }

</script>
</body>
</html>