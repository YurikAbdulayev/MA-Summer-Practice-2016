<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Профорієнтаційний тест</title>
    <link rel="stylesheet" href="../static/css/main.min.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:600,400&subset=latin,cyrillic' rel='stylesheet'
          type='text/css'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script src="js/run_test.js"></script>-->
</head>
<body>
<form action="/">
    <h1>
        <button onclick="deleteStorage()">Закінчити тест</button>
    </h1>
</form>
<h1 class="head-text" id="number_question_in_list"></h1>
<div id="content">
    <h1 class="head-text">
        <div id="question_body"></div>
    </h1>
    <div id="block_answers_in_q" class="test"></div>
</div>
<script type="text/javascript">
    var ids = [];
    var xmlhttp = new XMLHttpRequest();
    var list_answers;
    var l;
    var id;
    runTest();
    function runTest() {
        list_answers = localStorage.getItem("list_answ");
//        localStorage.removeItem("list_answ");
        l = JSON.parse(list_answers);
        id = '{{t_id}}';
        if (list_answers == null) {
            getListQuestionsIds(id, 0)
        } else {
//            alert("local storage exist");
//            alert(JSON.stringify(l));
            nextQuestion()
        }
    }

    function deleteStorage() {
        localStorage.removeItem("list_answ");
    }

    function nextQuestion() {
        var obj = l;
        endPart = false;
        for (qw = 0; qw < obj["count"]; qw++) {
            if (obj["answers"][qw] == null) {
                getQuestion(qw, obj);
                endPart = false;
                break
            }
            else {
                endPart = true;
            }
        }
        if (endPart) {
            calculationAnswers(l["answers"])
        }
    }
    var max;
    function calculationAnswers(list) {
//        alert(list);
        var listMap = {};
        var listKey = [];
        for (i = 0; i < list.length; i++) {
            var value = 0;
            count = 0;
            for (j = 0; j < list.length; j++) {
                value = list[i];
                if (value == list[j]) {
                    count++
                }
            }
            listMap[list[i]] = count;
            listKey[i] = list[i];
        }
        max = 0;
        v = 0;
        var key = 0;
        for (i = 0; i < listKey.length; i++) {
            key = listKey[i];
            for (j = 0; j < listKey.length; j++) {
                v = listMap[key];
                if (v >= listMap[listKey[j]]) {
                    max = key;
                }
            }
        }
        var povt = false;
        var povtL = [max];
        keyz = Object.keys(listMap);
        for (z = 0; z < Object.keys(listMap).length; z++) {
//            alert("listM = " + keyz[z] + ":" + listMap[keyz[z]]);
            if (listMap[keyz[z]] == listMap[max] && keyz[z] != max) {
                povtL.push(keyz[z]);
                povt = true;
            }
        }
//        alert(max + " " + povt + " l=" + povtL);
        if (povt) {
//            getControlQuestion()
            getListQuestionsIds(id, max)
        } else {
            getListQuestionsIds(id, max)
        }
    }

    function getControlQuestion() {
        var url = "http://127.0.0.1:5000/api/v1.0//" + obj["questions"][questionId];
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                parseQuestion(xmlhttp.responseText, questionId, obj);
            }
        };
        xmlhttp.open("GET", url, false);
        xmlhttp.send();
    }

    function getQuestion(questionId, obj) {
        var url = "http://127.0.0.1:5000/api/v1.0/question/" + obj["questions"][questionId];
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                parseQuestion(xmlhttp.responseText, questionId, obj);
            }
        };
        xmlhttp.open("GET", url, false);
        xmlhttp.send();
    }

    function parseQuestion(result, questionId, storage) {
        var obj = JSON.parse(result);
        st = storage;
        q_id = questionId;
        var outAsnwers = "";
        document.getElementById("question_body").innerHTML = obj["question"]["body"];
        document.getElementById("number_question_in_list").innerHTML = questionId + 1 + " із " + storage["count"];
        ans = obj["question"];
        outAsnwers += "<div id='myForm'>";
        for (i = 0; i < ans["answers"].length; i++) {
            outAsnwers += "<p class='answer'><input type='radio' id='radio" + ans["answers"][i]["direction"] + "' " +
                    "name='answer' value='" + ans["answers"][i]["direction"] + "'>" +
                    "<label for='radio" + ans["answers"][i]["direction"] + "'" +
                    ">" + ans["answers"][i]["body"] + "</label></p>"
        }
        outAsnwers += "</div>";
        outAsnwers += "<button onclick='calcAnswer(q_id)' type='submit' class='button'>Далі</input>";
        document.getElementById("block_answers_in_q").innerHTML = outAsnwers;
    }

    function calcAnswer(questionId) {
        var answer = document.getElementsByName("answer");
        var answCount = answer.length;
        for (a = 0; a < answCount; a++) {
            if (answer[a].checked) {
                l["answers"][questionId] = parseInt(answer[a].value);
                localStorage.setItem("list_answ", JSON.stringify(l));
                nextQuestion()
            }
        }
    }

    function getListQuestionsIds(id, direction) {
        localStorage.removeItem("list_answ");
        var url = "http://127.0.0.1:5000/api/v1.0/questions/" + id + "/direction/" + direction;

        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                parseListIds(xmlhttp.responseText);
            }
        };
        xmlhttp.open("GET", url, false);
        xmlhttp.send();
    }

    function parseListIds(response) {
        var json = JSON.parse(response);
        if (json["list_ids"].length != 0) {
            for (i = 0; i < json["list_ids"].length; i++) {
                ids[i] = json["list_ids"][i]["question_id"]
            }
            list_answers = '{"count": "' + parseInt(json["list_ids"].length) + '", "answers":[], "questions":[' + ids + ']}';
            localStorage.setItem("list_answ", list_answers);
//            alert("local storage not exist");
//            nextQuestion();
            runTest()
        } else {
//            finish test !!!!!!!!!!!!!!!!!!!!!!111
            alert("FINISH");
            finish(max);
            localStorage.removeItem("list_answ")

        }
    }

    function finish(direction_finish_id) {
        var res;
        var url = "http://127.0.0.1:5000/api/v1.0/direction/" + direction_finish_id;
        localStorage.removeItem("list_answ");
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                res = xmlhttp.responseText;
            }
        };
        xmlhttp.open("GET", url, false);
        xmlhttp.send();
        res = JSON.parse(res);
//        alert(JSON.stringify(res));

        out = "<div id='content'>" +
                "<h1 class='head-text'>" + res["direction"] + "</h1>" +
                "<img src='img/1.png' alt='' class='image'>" +
                "<p class='result'>" +
//                "Твоя ідеальна професія може бути пов’язана з дизайном стилю та зачіски. Ти креативний, комунікабельний, працьовитий, маєш гарні уяву та естетичний смак, володієш чудовим відчуттям стилю та мрієш привнести у світ щось нове, гарно поєднуєш речі, які багатьом на перший погляд здаються несумісними." +
//                "</p><p class='result'>" +
//                "В майбутньому ти можеш стати як Коко Шанель, яку по праву вважають найважливішою фігурою в історії моди XX століття. Шанель принесла в жіночу моду приталений жакет і маленьку чорну сукню, під її керівництвом було створено всесвітньо відомі парфуми «Chanel № 5». Вплив Коко на високу моду був такий сильний, що її — єдину з історії моди — журнал «Тime» вніс до списку ста найвпливовіших людей XX століття." +
//                "</p><p style='text-align: center; color: #acacac;' class='result'>" +
//                "Цікавий факт! Саме Коко Шанель запровадила моду на засмагу. Це сталось на початку 1920-х рр., коли вона повернулась із відпочинку на яхті із золотаво–бронзовою шкірою. Доти взірцевою була порцеляново біла шкіра." +
//                "</p><p style='text-align: center; font-weight: bold;' class='result'>" +
                "Дану професію ти можеш опанувати обравши навчання у ЧДБК за освітньою програмою «" + res["direction"] + "»." +
                "</p></div>";
        document.getElementById("content").innerHTML = out;
    }

</script>
</body>
</html>